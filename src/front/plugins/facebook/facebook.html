<html>
<head>
    <title>Facebook</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <style type="text/css">
        body {
            margin: -10px 0;
            overflow: hidden;
        }
        .fb-post {
            margin: 10px auto;
        }
    </style>
</head>
<body>
    <script type="text/javascript">
        (window.OctoBoot_plugins = window.OctoBoot_plugins || {}).facebook_plugin = function(pid, nbr) {
            if (!pid) {
                console.error('Facebook Plugin error - page id missing')
            }

            container = document.body;
            var count = nbr = nbr || 1;


            /**
             * APPEND POST
             */
            var ids, post_url;
            var appendPost = function(url) {
                var width = $(container).width() > 750 ? 750 : $(container).width();
                var dom = document.createElement('div');
                dom.className = 'fb-post';
                dom.setAttribute('data-href', url);
                dom.setAttribute('data-width', width)
                
                if (width > 750) {
                    $(parent.document).find('iframe.' + pid + nbr).css('width', width);
                }
                
                container.appendChild(dom); 
            };

            /**
             * RESIZE
             */
            var previous_width;
            var resize = function() {
                var current_width = document.body.offsetWidth
                console.log(this, 'resize', previous_width !== current_width, previous_width , current_width, 'iframe.' + pid + nbr)
                if (previous_width !== current_width) {
                    $(parent.document).find('iframe.' + pid + nbr).css('height', document.body.offsetHeight + 'px')
                    previous_width = current_width
                }
            }
            window.addEventListener('resize', resize)

            /**
             * GET FEEDS / START
             */
            $.get('http://octoboot.soizen.ovh/facebook/' + pid + '/feed', function(feeds) {
                feeds.forEach(function(post_id) {
                    if (count) {
                        ids = post_id.split('_');
                        post_url = 'https://www.facebook.com/' + ids[0] + '/posts/' + ids[1];
                        appendPost(post_url);
                        count--
                    }
                })
                if (FB) {
                    FB.XFBML.parse()
                    var inter = setInterval(function() {
                        console.log('check rendered')
                        if ($('.fb-post').length === $('[fb-xfbml-state="rendered"]').length) {
                            console.log('rendered ok -> resize')
                            clearInterval(inter);
                            resize(); 
                        }
                    }, 500);
                }
            });
        }

        /**
         * Facebook SDK async callback
         */
        window.fbAsyncInit = function() {
          FB.init({
            xfbml      : true,
            version    : 'v2.5'
          });
        };

        /**
         * Facebook SDK Tag
         */
        (function(d, s, id){
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {return;}
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        /**
         * Search for data in location and start process
         */
        if (location.search) {
            iframe_data = location.search.replace('?', '').split('|')
            OctoBoot_plugins.facebook_plugin(iframe_data[0], parseInt(iframe_data[1]))
        } else {
            console.error('facebook module error: facebook id missing on location')
        }
    </script>

</body>
</html>
